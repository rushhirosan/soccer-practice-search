# Cursor Rules: セキュリティ共通ルール

この内容をCursorのUser Rulesに追加してください。

---

## 🔒 セキュリティ共通ルール（全プロジェクト適用）

### 秘密情報の取り扱い

#### 絶対にコミットしてはいけないもの
- `.env` ファイル（環境変数ファイル全般）
- `.env.local`, `.env.production` などの環境別設定ファイル
- `*.bak`, `*.backup` ファイル（バックアップファイル全般）
- APIキー、トークン、パスワードを含むファイル
- 秘密鍵（private keys）
- 認証情報を含む設定ファイル

#### .gitignoreの必須設定
以下のパターンを必ず含めること：
```
# 環境変数ファイル
.env
.env.local
.env.production
.env.development
.env*.bak
.env*.backup

# バックアップファイル全般
*.bak
*.backup

# 秘密情報を含む可能性のあるファイル
*.key
*.pem
*.p12
*.pfx
secrets/
.secrets/
```

#### コミット前の必須チェック
1. **`git status` で追加されるファイルを確認**
   - `.env` や `.bak` ファイルが含まれていないか
   - 予期しないファイルが追加されていないか

2. **`git diff` で変更内容を確認**
   - 秘密情報（APIキー、パスワードなど）が含まれていないか
   - 環境変数の値が含まれていないか

3. **パターンチェック**
   - Google API Key: `AIza[0-9A-Za-z_-]{35}`
   - GitHub Token: `ghp_[0-9A-Za-z]{36}`
   - OpenAI API Key: `sk-[0-9A-Za-z]{32,}`
   - その他の秘密情報のパターン

#### バックアップファイルの管理
- ❌ **やってはいけない**: リポジトリ内に `.bak` ファイルを作成
- ✅ **正しい方法**: 
  - リポジトリ外にバックアップ（例: `~/backups/`）
  - `.gitignore` に含まれるディレクトリにバックアップ（例: `.backup/`）
  - バージョン管理システムを使用（1Password, AWS Secrets Manager など）

#### 環境変数の管理
- **ローカル開発**: `.env.local` を使用（`.gitignore`に含める）
- **本番環境**: 環境変数として直接設定、ファイルに保存しない
- **テンプレート**: `.env.example` を作成（秘密情報なし）

#### インシデント発生時の対応
1. **即座に無効化**: APIキー、トークンを無効化
2. **Git履歴から削除**: `git filter-branch` または `git filter-repo` を使用
3. **新しいキーを生成**: 無効化したキーの代替を生成
4. **強制プッシュ**: 履歴を完全に削除（注意が必要）
5. **監視**: GitHub Secret Scanningアラートを確認

#### コードレビュー時の注意
- 環境変数ファイルが含まれていないか確認
- ハードコードされた秘密情報がないか確認
- ログに秘密情報が出力されていないか確認
- エラーメッセージに機密情報が含まれていないか確認

#### 定期的な監査
- リポジトリ内の秘密情報を検索
- `.gitignore` の見直し
- GitHub Secret Scanningアラートの確認
- 依存関係のセキュリティ監査

---

## 🛠️ 実装推奨事項

### Git Hooks
pre-commitフックを設定して、コミット前に自動チェック：
- 環境変数ファイルの検出
- 秘密情報パターンの検出
- バックアップファイルの検出

### ツールの活用
- **git-secrets**: AWS提供の秘密情報検出ツール
- **truffleHog**: リポジトリ全体のスキャン
- **GitGuardian**: 継続的な監視

### ドキュメント
- `SECURITY.md`: セキュリティポリシー
- `.env.example`: 環境変数のテンプレート
- `docs/SECURITY_INCIDENT_ANALYSIS.md`: インシデント分析と再発防止策

---

## ⚠️ 重要な注意事項

1. **秘密情報は絶対にコミットしない**
2. **バックアップファイルもコミットしない**
3. **コミット前は必ず `git status` と `git diff` を確認**
4. **環境変数は `.env.example` テンプレートを使用**
5. **本番環境では環境変数として直接設定**

---

このルールは全てのプロジェクトに適用し、常に遵守すること。

